.. highlight:: bash
.. _vibration:

=======================================================================
Vibration section
=======================================================================

Normal mode analysis
====================


*Vibration is available only in* **ATDYN**.

In the **[VIBRATION]** section, users can specify keywords for molecular
vibrational analysis. Vibrational analysis in **GENESIS** is done 
for a subsystem, i.e., for a molecule of interest in the system.  

In the normal mode analysis, the potential energy surface (PES) is truncated at the second-order 
Taylor expansion around the equilibrium geometry,

   .. math::
    V \simeq V_0 + \frac{1}{2} \sum_{i,j}^{3N} h_{ij} \xi_i \xi_j,

where :math:`N` is the number of atoms in the subsystem, :math:`\xi_i = \sqrt{m_i} x_i` are the 
mass-weighted coordinates and :math:`h_{ij}` is the Hessian matrix,

   .. math::
    h_{ij} = \frac{1}{\sqrt{m_i m_j}}\frac{\partial^2 V}{\partial x_i \partial x_j}.

In this approximation, the exact solution to the vibrational |Schrodinger| equation can be 
obtained by diagonalization of the Hessian matrix,

   .. math::
    \mathbf{H C} = \mathbf{\omega^2 C}, \\
    Q_i = \sum_{j=1}^{3N} C_{ji} \xi_j.

yielding the normal modes (:math:`\mathbf{Q}`) and the harmonic frequencies (:math:`\mathbf{\omega}`).
The Hessian matrix is calculated by numerical differentiations of the gradient,

   .. math::
    \frac{\partial^2 V}{\partial x_i \partial x_j} \simeq
    \frac{1}{2 \delta_i} \left( \frac{\partial V (+\delta_i)}{\partial x_j} 
    - \frac{\partial V(-\delta_i)}{\partial x_j} \right).

This step requires *6N* number of gradient calculations, which are
parallelized over MPI processors.

The information is output to a minfo file, which can be visualized by a 
molecular vibrational program, `SINDO <https://tms.riken.jp/en/research/software/sindo/>`_. 

-----------------------------------------------------------------------

**runmode** *HARM / QFF / GRID*

  **Default : HARM**

  Specifies the type of calculation. **HARM** invokes the harmonic analysis. 
  **QFF** and **GRID** are options for generating anharmonic potential (see below). 

**nreplica** *Integer*

  **Default : 1**

  The number of MPI processes.

**vibatm_select_index** *Integer*

  **Default: N/A**

  Indices of a group of atoms to specify a target subsystem  
  for vibrational analyses.  The indices must be defined in 
  **[SELECTION]** (see :ref:`selection`).

**output_minfo_atm** *Integer*

  **Default: N/A**

  Indices of a group of atoms, which are printed to a minfo file 
  in addition to the target subsystem. This option is useful 
  when one would like to visualize the atoms surrounding the  
  target subsystem.  The indices must be defined in 
  **[SELECTION]** (see :ref:`selection`).

**diff_stepsize** *Real*

  **Default : 0.01** (unit: |A|)

  The size of numerical differentiations when generating the Hessian matrix. 

**minfo_folder** *Character*

  **Default : minfo.files** 

  The name of a directory where intermediate minfo files are stored. 
  If the directory and intermediate files are present, the program restarts from 
  where it ended in the last run.

.. note::
  The geometry of the subsystem needs to be optimized prior to the 
  vibrational analysis. RMSG < 0.35 kcal/mol/|A| is recommended.


Anharmonic vibrational calculations
===================================

Anharmonic vibrational calculations take into account the third- and higher-order 
terms of the PES neglected in the normal mode analysis, thereby yielding a more 
accurate result. **runmode=QFF** generates a quartic force field (QFF), which 
is the fourth-order Taylor expansion,

   .. math::
    V(\mathbf{Q}) = V_0 + \sum_{i} c_{ii}{Q_i^2} + \sum_{i,j,k} c_{ijk} Q_i Q_j Q_k 
                  + \sum_{i,j,k,l} c_{ijkl} Q_i Q_j Q_k Q_l.

Another mode is **runmode=GRID**, which generates the anharmonic PES over grid points.
The grid points are provided by `MakePES` routine of SINDO, and GENESIS calculates 
the PES at those points. Finally, the anharmonic PES is generated and the vibrational 
|Schrodinger| equation is solved by SINDO. 

-----------------------------------------------------------------------

**gridfile** *Character*

  **Default : makeQFF.xyz** for QFF and **makeGrid.xyz** for GRID 

  The name of a file containing the XYZ coordinates of grid points for generating 
  the anharmonic PES. The xyz file is generated by MakePES module of SINDO.  

**datafile** *Character*

  **Default : makeGrid.dat** 

  The name of a file containing the energy, dipole moment, etc. at grid points 
  specified by **gridfile**.  The file is used by SINDO for generating GRID potentials. 

-----------------------------------------------------------------------

Examples
========

In the following example, the vibrational analysis is performed for a 
subsystem (phosphate ion) composed of segment ID = PO4 (group3).
2 MPI processors are used to calculate the gradients at grid points of 
numerical differentiations.  The output is written to a minfo file, 
where the coordinates of target atoms (group3) and residues (water 
molecules) 3.0 |A| around the target atoms (group4) are printed.
::

  [OUTPUT]
  minfofile = qmmm_harm.minfo
  
  [VIBRATION]
  runmode             = HARM
  nreplica            = 2
  vibatm_select_index = 3
  output_minfo_atm    = 4
  
  [SELECTION]
  ...
  group3  = sid:PO4
  group4  = sid:PO4 around_res: 3.0

The following example illustrates the generation of QFF,
:: 

  [VIBRATION]
  runmode             = QFF
  nreplica            = 2
  vibatm_select_index = 3
  gridfile            = makeQFF.xyz
  minfo_folder        = minfo.files

The following example illustrates the generation of Grid PES,
:: 

  [VIBRATION]
  runmode             = GRID
  nreplica            = 2
  vibatm_select_index = 3
  gridfile            = makeGrid.xyz
  datafile            = makeGrid.dat

For more details, see `tutorial-15-4 <https://www.r-ccs.riken.jp/labs/cbrt/tutorials2022/tutorial-15-4/>`_.

.. |Schrodinger| unicode:: Schr 0xf6 dinger .. umlaut o
.. |A| unicode:: 0xc5 .. Angstrom

